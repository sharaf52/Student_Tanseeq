<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯Ù†ÙŠØ§</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 3px solid #007bff;
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .major-section {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .section-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .form-control {
            font-size: 1.2rem;
            padding: 10px;
            text-align: center;
        }
        .btn-primary {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px;
        }
        .alert {
            display: none;
            margin-top: 15px;
            text-align: center;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .result-item {
            padding: 10px;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .assigned {
            color: #28a745;
        }
        .not-assigned {
            color: #dc3545;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯Ù†ÙŠØ§</h2>
    <div id="messageBox" class="alert" role="alert"></div>
    <form id="limitsForm">
        <div id="limitsContainer"></div>
        <button type="submit" id="saveBtn" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ÙˆØ¯</button>
    </form>

    <button onclick="distributeStudents()" class="btn btn-success mt-3 w-100 py-3">
        ğŸš€ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø±ØºØ¨Ø§Øª
    </button>
    <!-- Ø²Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡ -->
    <button onclick="downloadExcel()" class="btn btn-primary mt-3">ØªØ­Ù…ÙŠÙ„ Ø±ØºØ¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</button>

    <script>
        function downloadExcel() {
            window.location.href = "/download_student_choices";
        }
    </script>


    <div id="results" class="mt-4"></div>

</div>

<script>
    // Ø§Ù„ØªØ®ØµØµØ§Øª ÙˆØ§Ù„Ø´Ø¹Ø¨ (ÙƒÙ…Ø§ Ù‡ÙŠ)
    let majors = [
        { name: "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø­Ø§Ø³Ø¨ Ø§Ù„Ø¢Ù„ÙŠ", color: "#e0e0e0" },
        { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©", color: "#d6e4f0" },
        { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„ÙÙ†ÙŠØ©", color: "#e0e0e0" },
        { name: "Ø§Ù„ÙÙ†ÙˆÙ† Ø§Ù„Ø±Ù‚Ù…ÙŠØ©", color: "#d6e4f0" },
        { name: "Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ", color: "#e0e0e0" },
        { name: "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø­Ø§Ø³Ø¨ Ø§Ù„Ø¢Ù„ÙŠ Ù…Ù…ÙŠØ²", color: "#d6e4f0" },
        { name: "Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„ØªØ±Ø¨ÙˆÙŠ", color: "#e0e0e0" }
    ];
    let sections = ["Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…", "Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©", "Ø£Ø¯Ø¨ÙŠ", "Ø£Ø®Ø±Ù‰"];

    // Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø¯ÙˆØ¯ (ÙƒÙ…Ø§ Ù‡Ùˆ)
    let container = document.getElementById("limitsContainer");
    majors.forEach(major => {
        let sectionDiv = document.createElement("div");
        sectionDiv.classList.add("major-section");
        sectionDiv.style.backgroundColor = major.color;

        let title = document.createElement("h4");
        title.textContent = major.name;
        sectionDiv.appendChild(title);

        let sectionContainer = document.createElement("div");
        sectionContainer.classList.add("section-container");

        sections.forEach(section => {
            let div = document.createElement("div");
            div.classList.add("mb-3");
            div.style.flex = "1 1 200px";

            let label = document.createElement("label");
            label.classList.add("form-label");
            label.textContent = section;

            let input = document.createElement("input");
            input.type = "number";
            input.classList.add("form-control");
            input.name = `${major.name}_${section}`;
            input.required = true;
            input.maxLength = 3;
            input.oninput = function () {
                if (this.value.length > 3) {
                    this.value = this.value.slice(0, 3);
                }
            };

            div.appendChild(label);
            div.appendChild(input);
            sectionContainer.appendChild(div);
        });

        sectionDiv.appendChild(sectionContainer);
        container.appendChild(sectionDiv);
    });

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ÙƒÙ…Ø§ Ù‡ÙŠ)
    function showMessage(message, type) {
        let messageBox = document.getElementById("messageBox");
        messageBox.textContent = message;
        messageBox.className = `alert alert-${type}`;
        messageBox.style.display = "block";
        setTimeout(() => { messageBox.style.display = "none"; }, 3000);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ÙˆØ¯ (ÙƒÙ…Ø§ Ù‡Ùˆ)
    document.getElementById("limitsForm").addEventListener("submit", function(event) {
        event.preventDefault();

        let formData = {};
        document.querySelectorAll("input").forEach(input => {
            let [major, section] = input.name.split("_");
            if (!formData[major]) formData[major] = {};
            formData[major][section] = input.value;
        });

        fetch("/save_limits", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            showMessage("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯Ù†ÙŠØ§ Ø¨Ù†Ø¬Ø§Ø­!", "success");
        })
        .catch(error => showMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸!", "danger"));
    });

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    function distributeStudents() {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹...</div>';

    fetch("/distribute_students", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                showMessage(data.message, "success");
                displayResults(data.results);
            } else {
                showMessage("Ø­Ø¯Ø« Ø®Ø·Ø£: " + data.message, "danger");
                resultsDiv.innerHTML = '<div class="alert alert-danger">ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>';
            }
        })
        .catch(error => {
            showMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…!", "danger");
            resultsDiv.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
        });
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    function displayResults(results) {
    let container = document.getElementById("results");
    let summary = `
        <div class="alert alert-info">
            <h4>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØ²ÙŠØ¹</h4>
            <p>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${results.total}</p>
            <p class="text-success">âœ… ØªÙ… ØªÙˆØ²ÙŠØ¹Ù‡Ù…: ${results.assigned}</p>
            <p class="text-danger">âŒ ØºÙŠØ± Ù…ÙˆØ²Ø¹ÙŠÙ†: ${results.not_assigned}</p>
        </div>
        <h4 class="mb-3">ğŸ“œ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹:</h4>
    `;

    let details = results.assignments.map(student => {
        const statusClass = student.status === "ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹" ? "assigned" : "not-assigned";
        return `
            <div class="result-item">
                <strong>${student.name}</strong> (<span class="text-primary">${student.score}</span>) -
                <span class="${statusClass}">${student.status}</span>
                ${student.assigned !== "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØºØ¨Ø© Ù…ØªØ§Ø­Ø©" ? ` â†’ <span class="text-info">${student.assigned}</span>` : ' âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØºØ¨Ø© Ù…ØªØ§Ø­Ø©'}
            </div>
        `;
    }).join('');

    container.innerHTML = summary + details;
}

</script>

</body>
</html>
